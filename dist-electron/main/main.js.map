{"version":3,"file":"main.js","sources":["../../electron/main.ts"],"sourcesContent":["/**\n * Electron 主進程\n * 處理視窗管理和檔案系統操作\n */\n\nimport { app, BrowserWindow, ipcMain, dialog } from 'electron';\nimport * as path from 'path';\nimport * as fs from 'fs';\n\n// 資料儲存路徑\nconst getDataPath = () => {\n  const userDataPath = app.getPath('userData');\n  const dataDir = path.join(userDataPath, 'data');\n  if (!fs.existsSync(dataDir)) {\n    fs.mkdirSync(dataDir, { recursive: true });\n  }\n  return dataDir;\n};\n\n// 創建主視窗\nconst createWindow = () => {\n  const mainWindow = new BrowserWindow({\n    width: 1400,\n    height: 900,\n    minWidth: 1024,\n    minHeight: 768,\n    webPreferences: {\n      preload: path.join(__dirname, '../preload/preload.js'),\n      contextIsolation: true,\n      nodeIntegration: false,\n      sandbox: false,\n    },\n    title: 'CivisOS 智慧社區管理系統',\n    show: false,\n  });\n\n  // 載入應用\n  if (process.env.VITE_DEV_SERVER_URL) {\n    mainWindow.loadURL(process.env.VITE_DEV_SERVER_URL);\n    mainWindow.webContents.openDevTools();\n  } else {\n    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));\n  }\n\n  mainWindow.once('ready-to-show', () => {\n    mainWindow.show();\n  });\n\n  return mainWindow;\n};\n\n// 應用程式就緒\napp.whenReady().then(() => {\n  createWindow();\n\n  app.on('activate', () => {\n    if (BrowserWindow.getAllWindows().length === 0) {\n      createWindow();\n    }\n  });\n});\n\napp.on('window-all-closed', () => {\n  if (process.platform !== 'darwin') {\n    app.quit();\n  }\n});\n\n// ============== IPC 處理器 ==============\n\n// 寫入 CSV 檔案（自動儲存）\nipcMain.handle('csv:writeFile', async (_, filename: string, content: string) => {\n  try {\n    const dataPath = getDataPath();\n    const filePath = path.join(dataPath, filename);\n    fs.writeFileSync(filePath, content, 'utf-8');\n    return { success: true, path: filePath };\n  } catch (error) {\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : '寫入失敗' \n    };\n  }\n});\n\n// 讀取 CSV 檔案\nipcMain.handle('csv:readFile', async (_, filename: string) => {\n  try {\n    const dataPath = getDataPath();\n    const filePath = path.join(dataPath, filename);\n    \n    if (!fs.existsSync(filePath)) {\n      return { success: true, content: '', exists: false };\n    }\n    \n    const content = fs.readFileSync(filePath, 'utf-8');\n    return { success: true, content, exists: true };\n  } catch (error) {\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : '讀取失敗' \n    };\n  }\n});\n\n// 列出所有 CSV 檔案\nipcMain.handle('csv:listFiles', async () => {\n  try {\n    const dataPath = getDataPath();\n    const files = fs.readdirSync(dataPath)\n      .filter(f => f.endsWith('.csv'))\n      .map(f => ({\n        name: f,\n        path: path.join(dataPath, f),\n        size: fs.statSync(path.join(dataPath, f)).size,\n        modified: fs.statSync(path.join(dataPath, f)).mtime,\n      }));\n    return { success: true, files };\n  } catch (error) {\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : '列出檔案失敗' \n    };\n  }\n});\n\n// 匯出 CSV（選擇位置）\nipcMain.handle('csv:export', async (_, filename: string, content: string) => {\n  try {\n    const { filePath } = await dialog.showSaveDialog({\n      defaultPath: filename,\n      filters: [\n        { name: 'CSV 檔案', extensions: ['csv'] },\n        { name: '所有檔案', extensions: ['*'] },\n      ],\n    });\n\n    if (filePath) {\n      fs.writeFileSync(filePath, content, 'utf-8');\n      return { success: true, path: filePath };\n    }\n    return { success: false, cancelled: true };\n  } catch (error) {\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : '匯出失敗' \n    };\n  }\n});\n\n// 匯入 CSV（選擇檔案）\nipcMain.handle('csv:import', async () => {\n  try {\n    const { filePaths } = await dialog.showOpenDialog({\n      properties: ['openFile', 'multiSelections'],\n      filters: [\n        { name: 'CSV 檔案', extensions: ['csv'] },\n        { name: '所有檔案', extensions: ['*'] },\n      ],\n    });\n\n    if (filePaths && filePaths.length > 0) {\n      const files = filePaths.map(filePath => ({\n        name: path.basename(filePath),\n        path: filePath,\n        content: fs.readFileSync(filePath, 'utf-8'),\n      }));\n      return { success: true, files };\n    }\n    return { success: false, cancelled: true };\n  } catch (error) {\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : '匯入失敗' \n    };\n  }\n});\n\n// 取得資料目錄路徑\nipcMain.handle('app:getDataPath', () => {\n  return getDataPath();\n});\n\n// 刪除 CSV 檔案\nipcMain.handle('csv:deleteFile', async (_, filename: string) => {\n  try {\n    const dataPath = getDataPath();\n    const filePath = path.join(dataPath, filename);\n    \n    if (fs.existsSync(filePath)) {\n      fs.unlinkSync(filePath);\n    }\n    return { success: true };\n  } catch (error) {\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : '刪除失敗' \n    };\n  }\n});\n"],"names":["app","path","fs","BrowserWindow","ipcMain","dialog"],"mappings":"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"}