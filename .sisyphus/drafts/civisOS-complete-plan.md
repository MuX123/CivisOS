# Draft: CivisOS Smart Community Management System Implementation Plan

## Requirements Analysis (from NEW.txt)

### BACKEND CONFIGURATION (後臺設定)

1. **Building Settings (棟數設定)**
   - Floors, R floors (roof), residential floors, basement with 3 zones
   - Auto-register units to building layout configuration

2. **Unit/Residence Management (戶別管理)**
   - Auto-register units to building layout after configuration
   - Manual addition allowed alongside auto-input

3. **Layout Configuration (格局配置)**
   - Auto-input available but manual addition allowed
   - Integration with building/floor structure

4. **Parking Configuration (車位配置)**
   - Based on layout settings
   - Add parking numbers per basement floor
   - Integration with basement zones

5. **Public Facilities Settings (公設設定)**
   - For reservation system selection
   - Available for booking system

6. **Color Settings (顏色設定)**
   - Custom colors for: parking, calendar, housing status
   - Status-based color changes throughout system

### FRONTEND SYSTEMS (前台設定)

1. **Calendar System (行事曆系統)**
   - Free add/edit/delete operations
   - Status-based colors (from backend settings)
   - Image support (URL input, unlimited images)
   - Auto-record time for all operations
   - Edit buttons and status selection windows
   - Default format: title, content, images
   - Two tabs: Current Calendar + Past Calendar (deleted/expired)

2. **Public Facilities System (公設系統)**
   - Building-based tabs as main sections
   - Status tabs: Now, Past, Cancelled, Deleted
   - Resident vs Other booking options
   - Payment tracking and status management
   - Auto-record registration time
   - Operation log functionality
   - Booking UI with resident/other selection

3. **Resident System (住戶系統)**
   - Auto-generated by building layout
   - Building-based tabs
   - Unit-floor data cards generated from layout
   - Status counts displayed per building
   - Member management (unlimited members, default 0)
   - Tenant management (unlimited tenants, default 0)
   - License plate integration with parking system
   - Access card (magnetic card) management
   - Three types: General Magnetic, Car ETC, Other ETC

4. **Parking Statistics (車位統計)**
   - Based on configuration settings
   - Display: parking number, current user, rental status
   - Visual indicators and color coding
   - "(租)" indicator for rented spaces

5. **Deposit System (寄放系統)**
   - Two categories: Keys/Magnetic Cards, Money/Loans
   - Unit and floor selection based on backend settings
   - Money management: add/reduce operations per unit
   - Complete logging functionality
   - Audit trail with timestamps and operator info

6. **Management Fee System (管理費系統)**
   - Auto-generate by building configuration
   - Calculate by square footage (坪數)
   - Per-unit square footage and rate settings
   - Special unit type settings
   - Multiple unit selection and summation
   - Custom square footage and pricing options

### CRITICAL INTEGRATION REQUIREMENTS

1. **Data Flow Integration**
   - Building → Floors → Units → Residents
   - Units ↔ Parking Spaces (license plates)
   - Residents ↔ Facility Bookings
   - Units ↔ Management Fees
   - All systems share status color theming

2. **Status Management**
   - Unified color scheme across all systems
   - Status-based filtering and display
   - Real-time status updates across related modules

3. **Audit Trails**
   - Complete operation logs for all critical actions
   - Timestamp recording for all user operations
   - User attribution for all changes

### CURRENT CODEBASE ANALYSIS

#### EXISTING COMPONENTS:
- ✅ BuildingFloorConfig.tsx - Building management interface
- ✅ FloorManager.tsx - Floor management
- ✅ UnitLayoutManager.tsx - Unit layout management
- ✅ ColorConfigPanel.tsx - Color configuration
- ✅ ParkingSystem.tsx - Parking management (basic)
- ✅ FacilitySystem.tsx - Facility management (basic)
- ✅ ResidentSystem.tsx - Resident management (basic)
- ✅ CalendarSystem.tsx - Calendar management (basic)
- ✅ PersistenceDemo.tsx - Data persistence demo

#### EXISTING REDUX MODULES:
- ✅ building.ts - Building state management
- ✅ floor.ts - Floor state management
- ✅ unit.ts - Unit state management
- ✅ parking.ts - Parking state management
- ✅ resident.ts - Resident state management
- ✅ facility.ts - Facility state management
- ✅ deposit.ts - Deposit state management
- ✅ calendar.ts - Calendar state management
- ✅ config.ts - Configuration state management
- ✅ eventBus.ts - IoT event bus
- ✅ auth.ts - Authentication

#### EXISTING DATA MODELS (from domain.ts):
- ✅ Building, Floor, Unit interfaces
- ✅ Resident, Member, AccessCard, LicensePlate interfaces
- ✅ ParkingArea, ParkingSpace, ParkingStats interfaces
- ✅ Facility, FacilityBooking, FacilityStats interfaces
- ✅ CalendarEvent, CommunityEvent interfaces
- ✅ Transaction, DepositRecord interfaces
- ✅ IoTDevice, IoTEvent interfaces

#### MISSING FROM NEW.TXT REQUIREMENTS:

1. **Enhanced Building/Floor Configuration**
   - Basement zone management (3 zones)
   - R floor (roof) configuration
   - Auto-unit registration workflow

2. **Enhanced Unit Management**
   - Complete unit-floor-building hierarchy
   - Special unit types for management fees
   - Square footage management

3. **Enhanced Calendar System**
   - Image URL support (unlimited images)
   - Status-based color theming
   - Two-tab system (current/past)
   - Auto-time recording

4. **Enhanced Facility System**
   - Building-based main tabs
   - Four status sub-tabs (now/past/cancelled/deleted)
   - Resident vs other booking options
   - Payment status integration

5. **Enhanced Resident System**
   - Unlimited member/tenant management
   - License plate-parking integration
   - Three-type magnetic card system
   - Status count displays

6. **New Deposit System Features**
   - Key/magnetic card category
   - Money/loan category with add/reduce operations
   - Complete audit logging
   - Unit-based selection

7. **New Management Fee System**
   - Per-unit square footage calculation
   - Special unit type handling
   - Multiple unit selection

8. **Enhanced Parking Statistics**
   - Rental status indicators
   - Current user display
   - Visual rental indicators "(租)"

### TECHNICAL ARCHITECTURE NEEDS:

1. **Enhanced Redux State**
   - Management fee slice
   - Enhanced deposit with detailed logging
   - Status-based color configuration
   - Audit logging system

2. **New Components Needed**
   - ManagementFeeSystem.tsx
   - Enhanced deposit components
   - Magnetic card management components
   - Image upload/display components
   - Enhanced status filters

3. **Integration Points**
   - Unit ↔ Management Fee calculation
   - Resident ↔ Parking license plate sync
   - All systems ↔ Color theming
   - Operations ↔ Audit logging

## GAP ANALYSIS RESULTS:

### Critical Missing Components:

1. **Management Fee System**: Completely missing from current implementation
   - No Redux slice for management fees
   - No calculation logic for square footage-based fees
   - No special unit type handling
   - No billing cycle management

2. **Enhanced Deposit System**: Current implementation is basic
   - Missing key/magnetic card category
   - Missing money/loan category with add/reduce operations
   - No detailed audit logging
   - No unit-based selection interface

3. **Magnetic Card Management Enhancement**: 
   - Current system only has basic access cards
   - Missing 3-type system: General Magnetic, Car ETC, Other ETC
   - No integration with parking system
   - Limited member association

4. **Calendar System Enhancements**:
   - Missing image URL support
   - No status-based color theming integration
   - Missing current/past tabs organization
   - No auto-time recording

5. **Facility System Workflow**:
   - Missing building-based main tabs
   - No 4-status sub-tabs (now/past/cancelled/deleted)
   - Missing resident vs other booking distinction
   - No payment status integration

6. **Parking-Resident Integration**:
   - License plates not synchronized with parking spaces
   - Missing rental status indicators "(租)"
   - No current user display enhancement

7. **Status Color Theming**:
   - Color configuration exists but not integrated across systems
   - Missing dynamic color application
   - No status-based color consistency

8. **Audit Trail System**:
   - No comprehensive logging system
   - Missing operation tracking
   - No user attribution
   - Missing ACID compliance for financial operations

### Best Practices Identified:

1. **Hierarchical Data Management**: Use graph database patterns for building-floor-unit relationships
2. **Access Control**: Implement role-based permissions with card type restrictions
3. **Financial Operations**: ACID compliance for all money transactions
4. **UI Organization**: Multi-tab interfaces with status-based filtering
5. **Real-time Updates**: WebSocket for live status changes
6. **Audit Logging**: Immutable logs with user attribution

## Open Questions:
- Specific parking zone configuration for basement (3 zones)
- Exact magnetic card workflow and numbering system
- Image upload method (URL input vs file upload)
- Payment processing integration requirements
- Management fee calculation periods and billing cycles
- Testing strategy preference (TDD, tests-after, manual-only)